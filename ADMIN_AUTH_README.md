# Безопасная верификация для страницы /admin

Реализована система безопасной аутентификации для административной панели.

## Компоненты системы

### 1. Middleware (`middleware/admin-auth.ts`)

- Автоматически проверяет аутентификацию при доступе к `/admin/*`
- Перенаправляет на `/admin/login` если пользователь не авторизован
- Проверяет валидность токена на сервере

### 2. API Endpoints

#### POST `/api/admin/login`

- Принимает пароль
- Проверяет пароль против `ADMIN_PASSWORD`
- Устанавливает secure cookie с токеном аутентификации
- Возвращает статус успеха/ошибки

#### GET `/api/admin/check`

- Проверяет валидность текущего токена
- Возвращает статус аутентификации

#### POST `/api/admin/logout`

- Удаляет токен аутентификации из cookies
- Завершает сессию

### 3. Страница входа (`pages/admin/login.vue`)

- Форма входа с полем пароля
- Обработка ошибок
- Автоматическое перенаправление после успешного входа

## Настройка

### Переменные окружения (ОБЯЗАТЕЛЬНО)

**ВНИМАНИЕ:** Без этих переменных система аутентификации не будет работать!

Создайте файл `.env` в корне проекта со следующим содержимым:

```env
# Пароль для входа в админ-панель (ОБЯЗАТЕЛЬНО)
ADMIN_PASSWORD=your-secure-password-here

# Секретный ключ для генерации токена аутентификации (ОБЯЗАТЕЛЬНО)
# Используйте длинную случайную строку (минимум 32 символа)
ADMIN_SECRET_KEY=your-secret-key-change-this-in-production
```

**Важно:**

- **ОБЯЗАТЕЛЬНО** установите обе переменные перед запуском приложения
- Никогда не коммитьте файл `.env` в репозиторий (уже в `.gitignore`)
- Используйте сложные пароли (минимум 16 символов)
- Генерируйте `ADMIN_SECRET_KEY` используя криптографически стойкий генератор случайных строк
- В production обязательно используйте HTTPS

### Генерация секретного ключа

Для генерации безопасного секретного ключа можно использовать:

```bash
# Linux/Mac
openssl rand -hex 32

# Или через Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

## Использование

1. **Создайте файл `.env`** в корне проекта с переменными `ADMIN_PASSWORD` и `ADMIN_SECRET_KEY`
2. Запустите приложение: `npm run dev`
3. Перейдите на `/admin` - вы будете перенаправлены на `/admin/login`
4. Введите пароль, установленный в `ADMIN_PASSWORD`
5. После успешного входа вы получите доступ к админ-панели
6. Для выхода нажмите кнопку "Выход" в админ-панели

**Если переменные окружения не установлены:**

- При попытке входа вы получите ошибку: "Конфигурация администратора не настроена"
- Необходимо создать файл `.env` с требуемыми переменными и перезапустить сервер

## Безопасность

### Реализованные меры безопасности:

1. **Secure Cookies**: Cookies помечены как `httpOnly` (защита от XSS)
2. **SameSite**: Cookies имеют флаг `sameSite: lax` (защита от CSRF)
3. **Secure Flag**: В production cookies передаются только по HTTPS
4. **Токен на основе SHA-256**: Токен генерируется с использованием криптографически стойкого хэша
5. **Server-side проверка**: Проверка токена происходит на сервере
6. **Middleware защита**: Все запросы к `/admin/*` проходят через middleware

### Рекомендации для production:

1. Используйте HTTPS для всего сайта
2. Регулярно меняйте `ADMIN_PASSWORD` и `ADMIN_SECRET_KEY`
3. Рассмотрите возможность использования JWT токенов с истечением срока действия
4. Добавьте rate limiting для страницы входа
5. Логируйте попытки входа (успешные и неуспешные)
6. Рассмотрите возможность двухфакторной аутентификации (2FA)

## Дополнительные улучшения (опционально)

Для еще большей безопасности можно:

1. **JWT токены** с истечением срока действия
2. **Rate limiting** для предотвращения brute-force атак
3. **CAPTCHA** на странице входа
4. **IP whitelist** для ограничения доступа по IP-адресам
5. **Audit log** для отслеживания всех действий в админ-панели

## Файлы, связанные с аутентификацией

- `middleware/admin-auth.ts` - Middleware для проверки аутентификации
- `server/api/admin/login.post.ts` - API endpoint для входа
- `server/api/admin/check.get.ts` - API endpoint для проверки сессии
- `server/api/admin/logout.post.ts` - API endpoint для выхода
- `pages/admin/login.vue` - Страница входа
- `pages/admin/index.vue` - Админ-панель (с примененным middleware)
- `nuxt.config.ts` - Конфигурация с runtimeConfig для секретных ключей
